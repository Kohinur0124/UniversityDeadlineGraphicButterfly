#include <graphics.h>
#include <conio.h>
#include <math.h>
int const n=3,m=3;
int const set=15;
int const kset=14*set;
typedef float b3 [n+1][m+1][3];
typedef float bs [kset][kset][3];
typedef int bsi [kset][kset][2];

unsigned int fact(int x)
{
if (x == 0)
return 1;
return x*fact(x - 1);
}

void pov_bezye(b3 P,bs &out,int pn)
{
float x,y,z;
for(float ii=(pn-1)*set;ii<set*pn;ii++)
for(float jj=(pn-1)*set;jj<set*pn;jj++)
{
float u=(ii-(pn-1)*set)/(set-1);
float v=(jj-(pn-1)*set)/(set-1);
x=0,y=0,z=0;
for(int i=0;i<n+1;i++)
for(int j=0;j<m+1;j++)
{
x+=fact(n)/(fact(i)*fact(n-i))*pow(u,i)*pow(1-u,n-i)*
fact(m)/(fact(j)*fact(m-j))*pow(v,j)*pow(1-v,m-j)*P[i][j][0];
y+=fact(n)/(fact(i)*fact(n-i))*pow(u,i)*pow(1-u,n-i)*
fact(m)/(fact(j)*fact(m-j))*pow(v,j)*pow(1-v,m-j)*P[i][j][1];
z+=fact(n)/(fact(i)*fact(n-i))*pow(u,i)*pow(1-u,n-i)*
fact(m)/(fact(j)*fact(m-j))*pow(v,j)*pow(1-v,m-j)*P[i][j][2];
}
out[int(ii)][int(jj)][0]=x;
out[int(ii)][int(jj)][1]=y;
out[int(ii)][int(jj)][2]=z;
}
}

void kabine(bs out,bsi &outi)
{
float x,y,z;
for(int i=0;i<kset;i++)
for(int j=0;j<kset;j++)
{
x=out[i][j][0];
y=out[i][j][1];
z=out[i][j][2];
x+=350;
y+=270;
outi[i][j][0]=int(x);//+0.5*cos(M_PI/4)*z);
outi[i][j][1]=int(y);//+0.5*sin(M_PI/4)*z);
}
}

void line_b(bsi outi,int c)
{
setcolor(c);
float x,y;
for(int k=1;k<=kset/set;k++)
for(int i=(k-1)*set;i<k*set;i++)
for(int j=(k-1)*set;j<k*set;j++)
{
x=outi[i][j][0];
y=outi[i][j][1];
if(j==(k-1)*set)
moveto(x,y);
else
lineto(x,y);
if(i>(k-1)*set)
{
lineto(outi[i-1][j][0],outi[i-1][j][1]);
moveto(x,y);
}
}
}

void povorot_x(bs &P,float a)
{
      float y,z;
      a/=180/M_PI;
      for(int i=0;i<kset;i++)
      for(int j=0;j<kset;j++)
      {
      y=P[i][j][1];
      z=P[i][j][2];
      P[i][j][1]=cos(a)*y-sin(a)*z;
      P[i][j][2]=sin(a)*y+cos(a)*z;
      }
}

void povorot_y(bs &P,float a)
{
      float x,z;
      a/=180/M_PI;
      for(int i=0;i<kset;i++)
      for(int j=0;j<kset;j++)
      {
      x=P[i][j][0];
      z=P[i][j][2];
      P[i][j][0]=cos(a)*x+sin(a)*z;
      P[i][j][2]=-sin(a)*x+cos(a)*z;
      }
}

void povorot_z(bs &P,float a)
{
      float x,y;
      a/=180/M_PI;
      for(int i=0;i<kset;i++)
      for(int j=0;j<kset;j++)
      {
      x=P[i][j][0];
      y=P[i][j][1];
      P[i][j][0]=cos(a)*x-sin(a)*y;
      P[i][j][1]=sin(a)*x+cos(a)*y;
      }
}

main()
{
initwindow(800, 800);

b3 P1={
{{-291,-219,0},{-299,-101,0},{-252,-68,0},{-252,3,0}},
{{-204,-210,0},{-204,-137,100},{-182,-59,100},{-203,29,0}},
{{-109,-164,0},{-208,-26,100},{-163,-31,100},{-84,-25,0}},
{{-18,-5,0},{-18,-5,0},{-18,-5,0},{-18,-5,0}},
};
b3 P2={
{{291,-219,0},{299,-101,0},{252,-68,0},{252,3,0}},
{{204,-210,0},{204,-137,100},{182,-59,100},{203,29,0}},
{{109,-164,0},{208,-26,100},{163,-31,100},{84,-25,0}},
{{18,-5,0},{18,-5,0},{18,-5,0},{18,-5,0}},
};



b3 P3={
{{-205,53,0},{-221,134,0},{-179,209,0},{-114,187,0}},
{{-164,29,0},{-137,78,100},{-117,127,100},{-90,207,0}},
{{-91,8,0},{-88,39,100},{-68,105,100},{-24,156,0}},
{{-17,3,0},{-17,3,0},{-17,3,0},{-17,3,0}},
};



b3 P4={
{{205,53,0},{221,134,0},{179,209,0},{114,187,0}},
{{164,29,0},{137,78,100},{117,127,100},{90,207,0}},
{{91,8,0},{88,39,100},{68,105,100},{24,156,0}},
{{17,3,0},{17,3,0},{17,3,0},{17,3,0}},
};


b3 P5={
{{-9,-41,0},{-5,-42,0},{5,-42,0},{9,-41,0}},
{{-15,-34,0},{-6,-35,25},{7,-35,25},{14,-34,0}},
{{-15,-26,0},{-6,-26,25},{8,-26,25},{14,-26,0}},
{{-10,-20,0},{-5,-17,0},{6,-17,0},{9,-22,0}},
};

b3 P6={
{{-13,-10,0},{-5,-18,0},{5,-18,0},{13,-10,0}},
{{-13,2,0},{-5,0,25},{5,0,25},{13,2,0}},
{{-12,11,0},{-6,13,25},{6,13,25},{12,11,0}},
{{-12,21,0},{-5,31,0},{5,31,0},{12,21,0}},
};


b3 P7={
{{-10,38,0},{-4,28,0},{4,28,0},{10,38,0}},
{{-11,49,0},{-6,49,25},{6,49,25},{11,49,0}},
{{-11,56,0},{-6,56,25},{6,56,25},{11,56,0}},
{{-10,65,0},{-6,74,0},{6,74,0},{10,65,0}},
};




b3 P11={
{{-291,-219,0},{-299,-101,0},{-252,-68,0},{-252,3,0}},
{{-204,-210,0},{-204,-137,-100},{-182,-59,-100},{-203,29,0}},
{{-109,-164,0},{-208,-26,-100},{-163,-31,-100},{-84,-25,0}},
{{-18,-5,0},{-18,-5,0},{-18,-5,0},{-18,-5,0}},
};
b3 P21={
{{291,-219,0},{299,-101,0},{252,-68,0},{252,3,0}},
{{204,-210,0},{204,-137,-100},{182,-59,-100},{203,29,0}},
{{109,-164,0},{208,-26,-100},{163,-31,-100},{84,-25,0}},
{{18,-5,0},{18,-5,0},{18,-5,0},{18,-5,0}},
};



b3 P31={
{{-205,53,0},{-221,134,0},{-179,209,0},{-114,187,0}},
{{-164,29,0},{-137,78,-100},{-117,127,-100},{-90,207,0}},
{{-91,8,0},{-88,39,-100},{-68,105,-100},{-24,156,0}},
{{-17,3,0},{-17,3,0},{-17,3,0},{-17,3,0}},
};



b3 P41={
{{205,53,0},{221,134,0},{179,209,0},{114,187,0}},
{{164,29,0},{137,78,-100},{117,127,-100},{90,207,0}},
{{91,8,0},{88,39,-100},{68,105,-100},{24,156,0}},
{{17,3,0},{17,3,0},{17,3,0},{17,3,0}},
};


b3 P51={
{{-9,-41,0},{-5,-42,0},{5,-42,0},{9,-41,0}},
{{-15,-34,0},{-6,-35,-25},{7,-35,-25},{14,-34,0}},
{{-15,-26,0},{-6,-26,-25},{8,-26,-25},{14,-26,0}},
{{-10,-20,0},{-5,-17,0},{6,-17,0},{9,-22,0}},
};

b3 P61={
{{-13,-10,0},{-5,-18,0},{5,-18,0},{13,-10,0}},
{{-13,2,0},{-5,0,-25},{5,0,-25},{13,2,0}},
{{-12,11,0},{-6,13,-25},{6,13,-25},{12,11,0}},
{{-12,21,0},{-5,31,0},{5,31,0},{12,21,0}},
};


b3 P71={
{{-10,38,0},{-4,28,0},{4,28,0},{10,38,0}},
{{-11,49,0},{-6,49,-25},{6,49,-25},{11,49,0}},
{{-11,56,0},{-6,56,-25},{6,56,-25},{11,56,0}},
{{-10,65,0},{-6,74,0},{6,74,0},{10,65,0}},
};


bs out;
bsi outi;
pov_bezye(P1,out,1);
pov_bezye(P2,out,2);
pov_bezye(P3,out,3);
pov_bezye(P4,out,4);
pov_bezye(P5,out,5);
pov_bezye(P6,out,6);
pov_bezye(P7,out,7);


pov_bezye(P11,out,8);
pov_bezye(P21,out,9);
pov_bezye(P31,out,10);
pov_bezye(P41,out,11);
pov_bezye(P51,out,12);
pov_bezye(P61,out,13);
pov_bezye(P71,out,14);


povorot_y(out,0);
povorot_x(out,0);
kabine(out,outi);
line_b(outi,15);
char ch;
while(int(ch)!=13)
{
ch=getch();
switch(int(ch))
{
case 55:
cleardevice();
povorot_x(out,3);
kabine(out,outi);
line_b(outi,15);
break;
case 56:
povorot_x(out,-3);
cleardevice();
kabine(out,outi);
line_b(outi,15);
break;
case 53:
povorot_y(out,3);
cleardevice();
kabine(out,outi);
line_b(outi,15);
break;
case 52:
povorot_y(out,-3);
cleardevice();
kabine(out,outi);
line_b(outi,15);
break;
case 50:
povorot_z(out,3);
cleardevice();
kabine(out,outi);
line_b(outi,15);
break;
case 49:
povorot_z(out,-3);
cleardevice();
kabine(out,outi);
line_b(outi,15);
break;
}
}
getch();
closegraph();
}
